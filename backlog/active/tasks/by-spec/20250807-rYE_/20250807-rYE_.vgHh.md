---
id: 20250807-rYE_.vgHh
title: Implement email verification fallback authentication
created: '2025-08-07'
updated: '2025-08-07'
spec: 20250807-rYE_
project: auth
status: done
archived: false
---

Implement email-based authentication with verification codes as fallback for users without Apple/Google accounts.

## Requirements
- Add POST /auth/send-email-code endpoint
- Add POST /auth/verify-email-code endpoint  
- Add POST /auth/link-email endpoint for existing users
- Email verification code flow (similar to SMS)
- Support for users who don't have Apple/Google accounts
- Integration with existing auth system

## Implementation Details
- Email service integration (use existing email system if available)
- Generate and store verification codes
- 6-digit verification codes with expiration
- Rate limiting on email sending
- Email templates for verification codes
- Link email accounts to existing users during migration

## Email Flow
1. User enters email address
2. System sends verification code via email
3. User enters code to verify email ownership
4. Account created or linked with auth_method='email'

## API Endpoints

### POST /auth/send-email-code
- Body: `{ "email": "user@example.com" }`
- Response: `{ "status": "sent", "email": "user@example.com" }`

### POST /auth/verify-email-code
- Body: `{ "email": "user@example.com", "code": "123456" }`
- Response: User object and JWT token (for new users)

### POST /auth/link-email
- Requires: Valid JWT token
- Body: `{ "email": "user@example.com", "code": "123456" }`
- Response: Updated user object with email set

## Security Considerations
- Rate limiting on email sending (max 3 per 15 minutes)
- Code expiration (10 minutes)
- Secure random code generation
- Email validation and sanitization
- Prevent enumeration attacks

## Integration
- Use existing email service if available
- Fallback option in migration screen
- Similar UX to SMS verification flow
- Support both new user signup and account linking

## Acceptance Criteria
- [ ] POST /auth/send-email-code endpoint implemented
- [ ] POST /auth/verify-email-code endpoint implemented
- [ ] POST /auth/link-email endpoint implemented
- [ ] Email verification codes sent reliably
- [ ] Rate limiting prevents abuse
- [ ] Codes expire after 10 minutes
- [ ] Works for new user signup
- [ ] Works for linking to existing accounts
- [ ] Integrated with migration screen as fallback option