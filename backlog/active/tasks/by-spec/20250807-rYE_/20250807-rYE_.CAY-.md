---
id: 20250807-rYE_.CAY-
title: Restrict SMS Authentication to Legacy Users Only
created: '2025-08-09'
updated: '2025-08-09'
spec: 20250807-rYE_
project: auth
status: todo
archived: false
---

## Objective
Implement Phase 2 of SMS authentication deprecation by restricting SMS signup to existing SMS-only users, while forcing new users to use Apple/Google/email authentication.

## Requirements

### Core Functionality
1. **SMS Signup Restriction**: Block new users from signing up with SMS
2. **Legacy User Access**: Allow SMS login only for users who have:
   - An existing phone number in the database AND
   - No Apple ID, Google ID, or email attached to their account
3. **Error Handling**: Show SMS signup option in UI but return clear error message when attempted by new users

### Technical Implementation

**Frontend (React Native/Expo)**:
- Update signup flow to show SMS option but handle rejection
- Display clear error message when SMS signup is attempted
- Add hardcoded config flag for enabling/disabling restrictions during development

**Backend (Clojure)**:
- Modify SMS signup endpoint to check if user already exists
- Implement user identification logic: `phone_number EXISTS AND apple_id IS NULL AND google_id IS NULL AND email IS NULL`
- Add hardcoded config constant for environment-based control
- Return appropriate error responses for blocked SMS signups

**Database Logic**:
- Query existing users table to determine SMS-only status
- No schema changes required (use existing fields)

### Environment Configuration
- Hardcoded config constant that can be easily toggled for development/testing
- Direct implementation without feature flags or gradual rollout

### Out of Scope
- Migration nudging/prompts (handled elsewhere)
- UI hiding of SMS options (show but block)
- Complex rollout mechanisms

## Acceptance Criteria
- [ ] New users cannot complete SMS signup flow
- [ ] Existing SMS-only users can still sign in with SMS
- [ ] Users with Apple/Google/email must use those methods (cannot fall back to SMS)
- [ ] Clear error messages for blocked SMS attempts
- [ ] Config can be easily modified for development environments
- [ ] Both frontend and backend implement restrictions