---
id: 20250807-rYE_.Ih8_
title: Admin User Authentication Migration Report CSV Endpoint
created: '2025-08-09'
updated: '2025-08-09'
spec: 20250807-rYE_
project: auth
status: todo
archived: false
---

## Objective
Create a minimal admin endpoint that exports user authentication migration status as a CSV file for monitoring the SMS authentication deprecation progress.

## Requirements

### Core Functionality
1. **CSV Export Endpoint**: `GET /admin/user-auth-migration-report`
2. **User Data Fields**: 
   - `id` - User ID
   - `name` - User's `:user/name` field
   - `migrated` - Boolean (true if has apple_id, google_id, or email)
   - `active_method` - Primary auth method (priority: apple > google > email > sms)
3. **Summary Totals**: Add totals at end after blank line showing migrated vs non-migrated counts
4. **Access Control**: Use existing admin Basic Auth (username/password from secrets)

### Technical Implementation

**Backend (Clojure)**:
- Add new route under existing `/admin` middleware in `gatz.api`
- Query all users from database with auth-related fields
- Implement migration status logic: `(or apple_id google_id email)`
- Generate CSV with proper headers and content-type
- Calculate and append summary totals

**Database Query**:
- Fetch all users with fields: `:user/id`, `:user/name`, `:user/apple_id`, `:user/google_id`, `:user/email`, `:user/phone_number`
- No additional schema changes needed

**CSV Format**:
```csv
id,name,migrated,active_method
user123,John Doe,true,apple
user456,Jane Smith,false,sms

TOTALS
Migrated,42
Non-migrated,18
```

**Response Headers**:
- `Content-Type: text/csv`
- `Content-Disposition: attachment; filename="user-auth-migration-report.csv"`

### Integration Points
- Extends existing admin infrastructure in `ddl.admin`
- Uses existing `wrap-admin-auth` middleware
- Follows existing admin route patterns

## Acceptance Criteria
- [ ] Endpoint accessible via GET `/admin/user-auth-migration-report`
- [ ] Protected by existing admin Basic Auth
- [ ] Returns CSV with id, name, migrated status, active method
- [ ] Migration status correctly identifies users with apple_id/google_id/email
- [ ] Active method follows priority: apple > google > email > sms
- [ ] Summary totals included after blank line
- [ ] Proper CSV content-type and download headers
- [ ] Handles database errors gracefully