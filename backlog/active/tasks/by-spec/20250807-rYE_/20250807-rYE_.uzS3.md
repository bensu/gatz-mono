---
id: 20250807-rYE_.uzS3
title: Implement account linking APIs
created: '2025-08-07'
updated: '2025-08-07'
spec: 20250807-rYE_
project: auth
status: done
archived: false
---

Implement APIs to link Apple/Google accounts to existing SMS-authenticated users without requiring re-authentication.

## Requirements
- Create POST /auth/link-apple endpoint for linking Apple accounts
- Create POST /auth/link-google endpoint for linking Google accounts  
- Link social accounts to currently authenticated users
- Update user's auth_method to 'hybrid' after linking
- Set migration_completed_at timestamp
- Allow users to sign in with either method after linking

## Implementation Details
- Validate that user is currently authenticated via JWT
- Accept Apple/Google ID tokens from authenticated users
- Verify social auth tokens are valid
- Check that social ID isn't already linked to another account
- Update user record with new social identifiers
- Return updated user data to client

## Security Considerations
- Verify user is authenticated before allowing linking
- Prevent linking same social account to multiple users
- Validate social auth tokens before linking
- Log account linking events for audit

## API Endpoints

### POST /auth/link-apple
- Requires: Valid JWT token in Authorization header
- Body: `{ "id_token": "apple_id_token" }`
- Response: Updated user object with apple_id set

### POST /auth/link-google  
- Requires: Valid JWT token in Authorization header
- Body: `{ "id_token": "google_id_token" }`
- Response: Updated user object with google_id set

## Acceptance Criteria
- [ ] POST /auth/link-apple endpoint implemented
- [ ] POST /auth/link-google endpoint implemented
- [ ] Only authenticated users can link accounts
- [ ] Social auth tokens validated before linking
- [ ] Prevents duplicate social account linking
- [ ] User auth_method updated to 'hybrid'
- [ ] migration_completed_at timestamp set
- [ ] Users can sign in with either method after linking