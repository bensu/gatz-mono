---
id: 20250808-0000.xv82
title: Implement Email-Based Account Linking for All Authentication Methods
created: '2025-08-08'
updated: '2025-08-08'
spec: null
project: null
status: done
archived: false
---

Implement automatic account linking during sign-in flows and manual linking endpoints for all authentication methods (Apple, Google, email, SMS) based on matching email addresses.

## Current State Analysis
- **Google Sign-In**: Already implements automatic linking (lines 610-632 in user.clj) - when user signs in with Google but no google_id exists, checks for existing users by email and automatically links the Google ID
- **Apple Sign-In**: Missing automatic linking - currently returns "requires_signup" instead of checking for existing email matches
- **Email Sign-In**: Missing automatic linking to existing Apple/Google accounts
- **Manual Linking**: Partial implementation exists (link-apple!, link-google!, link-email! endpoints) but needs completion

## Requirements
1. **Automatic linking during sign-in**: When user signs in with a provider (Apple/Google/email) but no account exists with that provider ID, check if an account exists with the same email address and automatically link the provider ID to that account
2. **Bidirectional authentication**: Users can sign in with any linked method to access the same account
3. **Auth method updates**: Update user/auth_method to "hybrid" when multiple methods are linked
4. **Trust OAuth tokens**: Use verified email addresses from Apple/Google OAuth tokens for linking without additional verification
5. **Preserve existing account**: Keep original account data intact, only add new provider IDs

## Implementation Tasks

### 1. Fix Apple Sign-In Auto-Linking
- Modify `apple-sign-in!` function to check for existing users by email when no apple_id match exists
- Mirror the Google sign-in auto-linking logic (lines 610-632)
- Update user record with apple_id and set auth_method to "hybrid" or "apple"

### 2. Add Email Sign-In Auto-Linking  
- Modify email authentication flow to check for existing Apple/Google accounts with same email
- Link email to existing social accounts when found
- Set auth_method to "hybrid" when linking to existing social accounts

### 3. Complete Manual Linking Endpoints
- Verify existing `link-apple!`, `link-google!`, `link-email!` endpoints work correctly
- Ensure proper error handling for conflicts and edge cases
- Add proper success/failure responses

### 4. Update Frontend Integration
- Modify AuthService.signInWithSocial to handle automatic linking responses
- Update error handling for new linking scenarios
- Test all sign-in flows with linked accounts

### 5. Testing
- Test automatic linking during sign-in for all combinations (Apple→Google, Google→Apple, email→social, social→email)
- Test manual linking endpoints
- Verify auth_method is updated correctly to "hybrid"
- Test error cases (deleted accounts, already linked accounts)

## Success Criteria
- User who creates account with Apple can sign in with Google using same email
- User who creates account with Google can sign in with Apple using same email  
- User who creates account with email can sign in with Apple/Google using same email
- User who creates account with SMS can link and sign in with Apple/Google/email using same email
- All linked authentication methods access the same user account with same user ID, username, and data
- Manual linking endpoints work for post-signup account linking
- Auth method correctly reflects "hybrid" when multiple methods are linked

## Technical Notes
- Email matching should be exact and case-insensitive
- Trust verified OAuth email addresses from Apple and Google tokens
- Maintain existing security validations and error handling
- Update CRDT clocks and user/updated_at when linking accounts
- Log account linking activities for audit purposes